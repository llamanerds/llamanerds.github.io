<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://kit.fontawesome.com/ed584df519.js" crossorigin="anonymous"></script>
        <style>
            @media (max-width: 400px) {
                #daily-info {
                    grid-template-columns: 100%;
                }
            }
            @media (min-width: 401px) {
                #daily-info {
                    grid-template-columns: 1fr 1fr;
                }
            }
            
            * {
                box-sizing: border-box;
            }
            div {
                padding: 5px;
            }
            body {
                align-items: center;
                background-color: #2677c3;
                display: flex;
                flex-flow: column;
                min-width: 350px;
            }
            #daily-info {
                background-color: white;
                border: 1px solid black;
                border-radius: 5px;;
                display: grid;
                gap: 5px;
                max-width: 500px;
                width: 100%;
                height: 165px;
                overflow-y: hidden;
            }
            #daily-info.expanded {
                height: auto;
            }
            #daily-info > div {
                text-align: center;
            }
            .day-info {
                display: flex;
                flex-flow: column;
                height: 75px;
                justify-content: space-evenly;
            }
            .day-info, #hourly-info {
                background-color: white;
                border: 1px solid black;
                border-radius: 5px;
            }
            .day-info > * {
                height: 32%;
                margin: 0px;
                padding: 0px;
            }
            #days, #header, #hours {
                margin: 10px 0;
                max-width: 500px;
                min-width: 285px;
                width: 100%;
            }
            #expand-days {
                background-color: #174876;
                border: 1px solid black;
                border-radius: 5px;
                color: white;
                text-align: center;
                width: 100%;
            }
            h1, h2 {
                margin: 0;
            }
            h2, #header {
                background-color: #174876;
                border: 1px solid black;
                border-radius: 10px;
                color: white;
                padding: 10px;
            }
            .hourly-header {
                color:#174876;
                font-size: 1.2em;
                font-weight: bold;
            }
            #hourly-info {
                border: 1px solid black;
                column-count: 3;
                column-gap: 5px;
                grid-template-columns: 1fr 1fr 1fr;
                display: grid;
                max-width: 500px;
                padding: 5px 0;
                width: 100%;
            }
            #hourly-info > *, .wind {
                align-items: center;
                display: flex;
                flex-flow: row nowrap;
                justify-content: center;
                height: 25px;
            }
            .wind > div {
                padding: 0 3px;
            }
            .odd {
                background-color: #dddddd;
            }
            .temp-precip {
                display: flex;
                flex-flow: row nowrap;
                justify-content: center;
            }
            .temp-precip > div {
                padding: 0 2px;
            }        
        </style>
        <script>
            class forecast
            {
                baseUrl; cwa; gridX; gridY; latitude; longitude;
                constructor (lat = 33.90597058201411, long = -118.01659580883346)
                {
                    this.latitude = lat;
                    this.longitude = long;
                    this.baseUrl = "https://api.weather.gov";

                    this.requestGridInfo ();
                }

                /** API Get code
                    let apiUrl = `${this.baseUrl}/_the_rest_of_the_api_url`;
                    fetch(apiUrl)
                    .then(response =>
                    {
                        if (!response.ok)
                        {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data =>
                    {
                        call_some_handler_function (data);
                    })
                    .catch (error => {
                        console.error('Error:', error);
                    });
                */

                catchDailyForecast (data)
                {
                    for (let i = 0; i < 10; i++)
                    {
                        let fcData = data.properties.periods[i];
                        let divHtml =
`<div class="day-info">
    <h3> ${fcData.name}</h3>
    <div class="temp-precip">
        <div><i class="fa-solid fa-temperature-high"></i> ${fcData.temperature}&deg;</div>
        <div>&sol;</div>
        <div>${fcData.probabilityOfPrecipitation.value}&percnt; <i class="fa-solid fa-droplet"></i></div>
    </div>
    <div class="wind">
        <div>${fcData.windSpeed}</div>
        <div>${this.drawArrow(fcData.windDirection)}</div>
    </div>
</div>`;
                        document.getElementById ("daily-info").innerHTML += divHtml;
                    }
                }

                catchHourlyForecast (data)
                {
                    let container = document.getElementById("hourly-info")
                    container.innerHTML = `<div class="hourly-header"><i class="fa-regular fa-clock"></i></div>
<div class="hourly-header"><i class="fa-solid fa-temperature-high"></i>&nbsp; &sol; &nbsp;<i class="fa-solid fa-droplet"></i></div>
<div class="hourly-header"><i class="fa-solid fa-wind"></i></div>`;
                    
                    for (let i = 0; i < 10; i++)
                    {
                        let fcData = data.properties.periods[i];

                        let time = `<div class="${i%2==0 ? 'even' : 'odd'}">${fcData.startTime.match(/T([0-9\:]{5})/)[1]}</div>`;
                        let temp = `<div class="${i%2==0 ? 'even' : 'odd'} temp-precip"><div>${fcData.temperature}&deg;</div><div>&sol;</div><div>${fcData.probabilityOfPrecipitation.value}&percnt;</div></div>`;
                        let wind = `<div class="${i%2==0 ? 'even' : 'odd'} wind"><div>${fcData.windSpeed}</div><div>${this.drawArrow(fcData.windDirection)}</div></div>`;

                        container.innerHTML += time + temp + wind;                        
                    }
                }

                catchGridInfo (data)
                {
                    this.cwa = data.properties.cwa;
                    this.gridX = data.properties.gridX;
                    this.gridY = data.properties.gridY;
                    console.log (`Grid info set:\n\tcwa: ${this.cwa}gridX: ${this.gridX}\t\n\n\tgridY: ${this.gridY}`);
                    this.requestDailyForecast ();
                    this.requestHourlyForecast ();
                }

                drawArrow (arrowDirection)
                {
                    var angles = ["S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW", "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE"];
                    let arrowAngle = angles.indexOf (arrowDirection) * 22.5;
                    let arrow = 
`<svg viewbox="0 0 60 60" xmlns="http://www.w3.org/2000/svg" style="height: 100%; width: auto;">
    <circle
        cx="30" cy="30" r="29"
        style="fill-opacity: 0; stroke: rgb(0,0,0); stroke-width: 1px;"
    />
    <polyline
        points="30,5 20,55 40,55 30,5"
        style="stroke: rgb(0,0,0); stroke-width: 1px;"
        transform="rotate(${arrowAngle} 30 30)"
    />
</svg>`;
                    return arrow;
                }

                requestDailyForecast ()
                {
                    let apiUrl = `${this.baseUrl}/gridpoints/${this.cwa}/${this.gridX},${this.gridY}/forecast`;
                    fetch(apiUrl)
                    .then(response =>
                    {
                        if (!response.ok)
                        {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data =>
                    {
                        this.catchDailyForecast (data);
                    })
                    .catch (error => {
                        console.error('Error:', error);
                    });
                   
                }

                requestHourlyForecast ()
                {
                    let apiUrl = `${this.baseUrl}/gridpoints/${this.cwa}/${this.gridX},${this.gridY}/forecast/hourly`;
                    fetch(apiUrl)
                    .then(response =>
                    {
                        if (!response.ok)
                        {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data =>
                    {
                        this.catchHourlyForecast (data);
                    })
                    .catch (error => {
                        console.error('Error:', error);
                    });
                   
                }

                requestGridInfo ()
                {
                    let apiUrl = `${this.baseUrl}/points/${this.latitude},${this.longitude}`;

                    fetch(apiUrl).then(response =>
                    {
                        if (!response.ok)
                        {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data =>
                    {
                        this.catchGridInfo (data);
                    })
                    .catch (error => {
                        console.error('Error:', error);
                    });
                }
            }

            function ecDays ()
            {
                let diElt = document.getElementById("daily-info");
                diElt.classList.toggle ("expanded");
                if ( diElt.classList.contains ("expanded") )
                    document.getElementById("expand-days").innerHTML = `<i class="fa-solid fa-angle-up"></i> Less <i class="fa-solid fa-angle-up"></i>`;
                else
                    document.getElementById("expand-days").innerHTML = `<i class="fa-solid fa-angle-down"></i> More <i class="fa-solid fa-angle-down"></i>`;

            }
            var biola = new forecast ();
        </script>
    </head>
    <body>
        <div id="header">
            <h1>SimpleWeather</h1>
            <div>for La Mirada, CA</div>
        </div>
        <div id="days">
            <h2>Daily weather</h2>
            <div id="daily-info"></div>
            <div id="expand-days" onclick="ecDays()"><i class="fa-solid fa-angle-down"></i> More <i class="fa-solid fa-angle-down"></i></div>
        </div>
        <div id="hours">
            <h2>Hourly weather</h2>
            <div id="hourly-info"></div>
        </div>
    </body>
</html>
